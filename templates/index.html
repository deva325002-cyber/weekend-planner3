<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekend Genie ✦ AI Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="bg-orbs">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <div class="container">
        <div class="chat-wrapper">
            <!-- Header -->
            <div class="header">
                <div class="header-glow"></div>
                <div class="header-content">
                    <div class="logo-mark">✦</div>
                    <h1>Weekend Genie</h1>
                    <p>Your AI Weekend Planning Oracle</p>
                </div>
                <div class="header-steps" id="progressSteps">
                    <span class="step active" data-step="1">Energy</span>
                    <span class="step-dot">·</span>
                    <span class="step" data-step="2">Budget</span>
                    <span class="step-dot">·</span>
                    <span class="step" data-step="3">Time</span>
                    <span class="step-dot">·</span>
                    <span class="step" data-step="4">Interests</span>
                    <span class="step-dot">·</span>
                    <span class="step" data-step="5">Who</span>
                    <span class="step-dot">·</span>
                    <span class="step" data-step="6">Plan ✦</span>
                </div>
            </div>

            <!-- Chat Box -->
            <div class="chat-box">
                <div id="messages" class="messages"></div>
            </div>

            <!-- Options Container (between chat and input) -->
            <div id="optionsContainer" class="options-container" style="display: none;"></div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container">
                    <input 
                        type="text" 
                        id="userInput" 
                        placeholder="Type your answer or choose above…" 
                        autocomplete="off"
                    >
                    <button type="button" class="send-btn" onclick="handleSend()">
                        <span class="send-icon">↑</span>
                    </button>
                </div>
                <p class="hint">Press Enter or click ↑ to send</p>
            </div>
        </div>
    </div>

    <script>
        const sessionId = 'session_' + Date.now();
        let currentStep = 1;

        // Enter key to send
        document.getElementById('userInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') handleSend();
        });

        // Initialize chat on load
        window.addEventListener('load', initializeChat);

        async function initializeChat() {
            try {
                const res = await fetch('/api/start-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });
                const data = await res.json();
                if (data.message) {
                    addMessage('assistant', data.message);
                    if (data.options && data.options.length > 0) {
                        showOptions(data.options);
                    }
                } else {
                    addMessage('assistant', data.error || 'Error starting chat. Please refresh.');
                }
            } catch (err) {
                addMessage('assistant', 'Connection error. Please refresh the page.');
            }
        }

        function handleSend() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message || input.disabled) return;

            // Handle quit
            if (['quit', 'exit', 'bye'].includes(message.toLowerCase())) {
                addMessage('user', message);
                addMessage('assistant', 'Goodbye! Have a magical weekend ✦');
                input.value = '';
                input.disabled = true;
                document.querySelector('.send-btn').disabled = true;
                return;
            }

            sendMessage(message);
        }

        async function sendMessage(message) {
            const input = document.getElementById('userInput');
            document.getElementById('optionsContainer').style.display = 'none';

            addMessage('user', message);
            input.value = '';
            input.disabled = true;

            // Show typing indicator
            const typingId = showTyping();

            try {
                const res = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, session_id: sessionId })
                });
                const data = await res.json();
                removeTyping(typingId);

                if (res.ok) {
                    addMessage('assistant', data.message);
                    if (data.options && data.options.length > 0) {
                        showOptions(data.options);
                    }
                    currentStep = Math.min(currentStep + 1, 6);
                    updateProgress();
                } else {
                    addMessage('assistant', 'Error processing message. Please try again.');
                }
            } catch (err) {
                removeTyping(typingId);
                addMessage('assistant', 'Connection error. Please try again.');
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        function addMessage(sender, text) {
            const container = document.getElementById('messages');
            const el = document.createElement('div');
            el.className = `message message-${sender}`;

            if (sender === 'assistant') {
                el.innerHTML = `
                    <div class="msg-avatar">✦</div>
                    <div class="msg-bubble">
                        <div class="markdown-content">${marked.parse(text)}</div>
                    </div>
                `;
            } else {
                el.innerHTML = `
                    <div class="msg-bubble user-bubble">
                        <p>${escapeHtml(text)}</p>
                    </div>
                    <div class="msg-avatar user-avatar">you</div>
                `;
            }

            container.appendChild(el);
            container.scrollTop = container.scrollHeight;
        }

        function showTyping(id) {
            const container = document.getElementById('messages');
            const el = document.createElement('div');
            const uid = 'typing-' + Date.now();
            el.id = uid;
            el.className = 'message message-assistant typing-message';
            el.innerHTML = `
                <div class="msg-avatar">✦</div>
                <div class="msg-bubble">
                    <div class="typing-dots"><span></span><span></span><span></span></div>
                </div>
            `;
            container.appendChild(el);
            container.scrollTop = container.scrollHeight;
            return uid;
        }

        function removeTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function showOptions(options) {
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';

            if (options && options.length > 0) {
                options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = option;
                    btn.onclick = () => sendMessage(option);
                    optionsContainer.appendChild(btn);
                });
                optionsContainer.style.display = 'flex';
            } else {
                optionsContainer.style.display = 'none';
            }
        }

        function updateProgress() {
            document.querySelectorAll('.step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.toggle('active', stepNum === currentStep);
                step.classList.toggle('done', stepNum < currentStep);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>